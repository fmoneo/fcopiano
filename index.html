<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Songbook - Stage Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Roboto+Mono:wght@500&display=swap');

        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        /* The Lyric Line: Holds the word-chord pairs */
        .lyric-line {
            display: flex;
            flex-wrap: wrap;
            row-gap: 1.5rem;
            /* Gap between wrapped lines */
            column-gap: 0rem;
            margin-bottom: 2rem;
            /* Space between paragraphs/sections */
            line-height: 1;
            align-items: flex-end;
        }

        /* Word Group: Vertical stack of Chord + Text */
        .word-group {
            display: inline-flex;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-end;
            min-height: 2.8rem;
            /* Ensures consistent vertical space for chords */
            vertical-align: bottom;
        }

        /* Chord Label: Positioned relatively within the stack */
        .chord {
            font-family: 'Roboto Mono', monospace;
            color: #ffffff;
            background-color: #7e22ce;
            font-weight: bold;
            padding: 8px 10px;
            border-radius: 5px;
            font-size: 1.00rem;
            margin-bottom: 4px;
            /* Space between chord and text */
            margin-right: 8px;
            /* FIX: This creates the space between [C] and [G] */
            white-space: nowrap;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
            transition: transform 0.1s ease, background-color 0.1s ease;
            z-index: 10;
            display: block;
        }

        .chord:hover {
            background-color: #9333ea;
            transform: scale(1.1);
        }

        .chord.minor-chord {
            background-color: #4c1d95;
            border: 1px solid #a78bfa;
        }

        .text-segment {
            font-size: 1.2rem;
            white-space: pre;
            display: inline-block;
            line-height: 1.2;
            color: #f3f4f6;
        }

        /* Helper for segments without chords to keep them aligned */
        .empty-chord-spacer {
            height: 1.2rem;
            /* Match chord height but invisible */
            margin-bottom: 4px;
            display: block;
        }

        /* Piano Styles */
        .white-key {
            fill: #f0f0f0;
            stroke: #333;
            stroke-width: 0.5;
        }

        .black-key {
            fill: #222;
            stroke: #000;
        }

        .key-active {
            fill: #a855f7 !important;
        }

        .sticky-controls {
            background: rgba(18, 18, 18, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-top: 3.5rem;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .section-label {
            color: #22d3ee;
            /* Cyan Color */
            text-transform: uppercase;
            font-size: 0.75rem;
            font-weight: 800;
            letter-spacing: 0.15em;
            padding-right: 16px;
        }

        .section-divider-line {
            flex-grow: 1;
            /* Makes the line stretch to the right margin */
            height: 1px;
            background-color: #164e63;
            /* Thin blue/cyan line */
            opacity: 0.6;
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 10px;
        }
    </style>
</head>

<body class="p-4 pb-48">

    <div id="search-screen" class="max-w-2xl mx-auto pt-8">
        <h1 class="text-4xl font-bold mb-8 text-center text-cyan-400">Piano Songbook</h1>

        <input type="text" id="searchInput" placeholder="Search song or artist..."
            class="w-full p-4 rounded-xl bg-zinc-800 border border-zinc-700 mb-6 focus:outline-none focus:border-cyan-500 text-lg">

        <div class="flex gap-2 mb-8 overflow-x-auto pb-2">
            <button onclick="setFilter('All')"
                class="bg-zinc-700 px-6 py-2 rounded-full whitespace-nowrap active:bg-cyan-600">All</button>
            <button onclick="setFilter('English')"
                class="bg-zinc-700 px-6 py-2 rounded-full whitespace-nowrap active:bg-cyan-600">English</button>
            <button onclick="setFilter('Spanish')"
                class="bg-zinc-700 px-6 py-2 rounded-full whitespace-nowrap active:bg-cyan-600">Español</button>
        </div>

        <div id="songList" class="space-y-3">
            <div class="text-center text-zinc-500">Loading library...</div>
        </div>
    </div>

    <div id="song-view" class="hidden max-w-3xl mx-auto">
        <div class="sticky-controls sticky top-0 py-4 z-20 flex items-center justify-between gap-2">
            <button onclick="showSearch()" class="p-2 text-zinc-400 hover:text-white">← Library</button>

            <div class="flex items-center gap-4 bg-zinc-900 px-4 py-1 rounded-full border border-zinc-700">
                <button onclick="transpose(-1)" class="text-2xl font-mono text-zinc-400 hover:text-cyan-400">−</button>
                <div class="text-center">
                    <div class="text-[10px] uppercase text-zinc-500 leading-none">Key</div>
                    <span id="transposeVal" class="font-bold text-cyan-400">0</span>
                </div>
                <button onclick="transpose(1)" class="text-2xl font-mono text-zinc-400 hover:text-cyan-400">+</button>
            </div>

            <button onclick="toggleVideo()" id="videoBtn"
                class="bg-red-900/20 text-red-500 px-4 py-2 rounded-lg border border-red-900/30 font-bold text-sm">VIDEO</button>
        </div>

        <div id="youtubeContainer" class="hidden mt-4 aspect-video rounded-xl overflow-hidden shadow-2xl"></div>

        <header class="mt-8 mb-12">
            <h2 id="songTitle" class="text-4xl font-bold text-white"></h2>
            <p id="songArtist" class="text-cyan-500 text-xl"></p>
        </header>

        <div id="lyricsArea" class="mb-20"></div>
    </div>

    <div id="visualizer"
        class="fixed bottom-0 left-0 right-0 bg-black/90 backdrop-blur-lg p-4 border-t border-zinc-800 hidden z-30">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-3 px-2">
                <span id="chordNameDisplay" class="font-bold text-cyan-400 text-xl uppercase tracking-widest"></span>
                <button onclick="closeVisualizer()" class="text-zinc-500 text-xs">CLOSE [X]</button>
            </div>
            <svg id="piano-svg" viewBox="0 0 280 80" class="w-full h-auto drop-shadow-lg"></svg>
        </div>
    </div>

    <script>
        let songs = [];
        let currentSong = null;
        let transposeAmount = 0;
        let activeLanguage = 'All';
        const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        const chordFormulas = {
            '': [0, 4, 7], 'm': [0, 3, 7], '7': [0, 4, 7, 10], 'maj7': [0, 4, 7, 11],
            'm7': [0, 3, 7, 10], 'sus4': [0, 5, 7], 'dim': [0, 3, 6]
        };

        async function fetchLibrary() {
            try {
                const response = await fetch('library.json');
                if (!response.ok) throw new Error("library.json not found");
                const data = await response.json();
                songs = data.songs;
                renderList();
            } catch (err) {
                document.getElementById('songList').innerHTML = `<div class="text-red-500 text-center">${err.message}</div>`;
                console.error(err);
            }
        }

        function renderList(search = '') {
            const list = document.getElementById('songList');
            list.innerHTML = '';

            const filtered = songs.filter(s => {
                const matchesSearch = s.title.toLowerCase().includes(search.toLowerCase()) ||
                    s.artist.toLowerCase().includes(search.toLowerCase());
                const matchesLang = activeLanguage === 'All' || s.language === activeLanguage;
                return matchesSearch && matchesLang;
            });

            filtered.sort((a, b) => a.title.localeCompare(b.title)).forEach(song => {
                const div = document.createElement('div');
                div.className = 'p-5 bg-zinc-800/50 rounded-xl cursor-pointer hover:bg-zinc-700 transition flex justify-between items-center border border-zinc-700/50';
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-lg text-white">${song.title}</div>
                        <div class="text-sm text-zinc-400">${song.artist}</div>
                    </div>
                    <div class="text-[10px] font-bold bg-zinc-700 px-2 py-1 rounded text-zinc-400 uppercase tracking-tighter">${song.language || 'N/A'}</div>
                `;
                div.onclick = () => loadSong(song);
                list.appendChild(div);
            });
        }

        async function loadSong(songMeta) {
            try {
                const response = await fetch(songMeta.file);
                currentSong = await response.json();
                transposeAmount = 0;
                document.getElementById('transposeVal').innerText = "0";
                document.getElementById('search-screen').classList.add('hidden');
                document.getElementById('song-view').classList.remove('hidden');
                renderSong();
                window.scrollTo(0, 0);
            } catch (err) {
                console.error("Error loading song file:", err);
            }
        }

        function showSearch() {
            document.getElementById('search-screen').classList.remove('hidden');
            document.getElementById('song-view').classList.add('hidden');
            document.getElementById('visualizer').classList.add('hidden');
            document.getElementById('youtubeContainer').classList.add('hidden');
            document.getElementById('youtubeContainer').innerHTML = '';
        }

        function transpose(dir) {
            transposeAmount += dir;
            document.getElementById('transposeVal').innerText = (transposeAmount > 0 ? '+' : '') + transposeAmount;
            renderSong();
        }

        function getShiftedChord(original) {
            return original.replace(/([A-G][b#]?)/g, (match) => {
                let idx = notes.indexOf(match);
                if (idx === -1) {
                    const flatMap = { 'Bb': 10, 'Eb': 3, 'Ab': 8, 'Db': 1, 'Gb': 6 };
                    idx = flatMap[match] || -1;
                }
                if (idx === -1) return match;
                let newIdx = (idx + transposeAmount) % 12;
                while (newIdx < 0) newIdx += 12;
                return notes[newIdx];
            });
        }

        function renderSong() {
            document.getElementById('songTitle').innerText = currentSong.title;
            document.getElementById('songArtist').innerText = currentSong.artist;
            const area = document.getElementById('lyricsArea');
            area.innerHTML = '';

            currentSong.content.forEach(section => {
                const headerDiv = document.createElement('div');
                headerDiv.className = 'section-header';

                const label = document.createElement('div');
                label.className = 'section-label';
                label.innerText = section.type;

                const lineElement = document.createElement('div');
                lineElement.className = 'section-divider-line';

                headerDiv.appendChild(label);
                headerDiv.appendChild(lineElement);
                area.appendChild(headerDiv);

                section.lines.forEach(line => {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'lyric-line';

                    const segments = line.lyrics.split(/(\[.*?\])/g);

                    segments.forEach((seg, i) => {
                        if (seg.startsWith('[')) {
                            const chordName = seg.replace(/[\[\]]/g, '');
                            const shifted = getShiftedChord(chordName);
                            const isMinor = shifted.includes('m') && !shifted.includes('maj');

                            const group = document.createElement('div');
                            group.className = 'word-group';

                            const chordSpan = document.createElement('span');
                            chordSpan.className = `chord ${isMinor ? 'minor-chord' : ''}`;
                            chordSpan.innerText = shifted;
                            chordSpan.onclick = (e) => { e.stopPropagation(); showOnPiano(shifted); };

                            let nextText = segments[i + 1] || "";
                            let textPart = "";

                            if (nextText) {
                                const words = nextText.split(/(\s+)/);
                                textPart = words[0] || "";
                                segments[i + 1] = nextText.substring(textPart.length);
                            }

                            const textSpan = document.createElement('span');
                            textSpan.className = 'text-segment';
                            textSpan.innerText = textPart || " ";

                            group.appendChild(chordSpan);
                            group.appendChild(textSpan);
                            lineDiv.appendChild(group);
                        } else if (seg.length > 0) {
                            // For plain text without chords, we still use a word-group stack
                            // to keep the text aligned horizontally with chorded words
                            const group = document.createElement('div');
                            group.className = 'word-group';

                            // This invisible spacer keeps the text at the bottom
                            const spacer = document.createElement('div');
                            spacer.className = 'empty-chord-spacer';

                            const textSpan = document.createElement('span');
                            textSpan.className = 'text-segment';
                            textSpan.innerText = seg;

                            group.appendChild(spacer);
                            group.appendChild(textSpan);
                            lineDiv.appendChild(group);
                        }
                    });
                    area.appendChild(lineDiv);
                });
            });
        }

        function createPiano() {
            const svg = document.getElementById('piano-svg');
            let html = '';
            for (let i = 0; i < 14; i++) html += `<rect id="white-${i}" class="white-key" x="${i * 20}" y="0" width="20" height="80" />`;
            [1, 2, 4, 5, 6, 8, 9, 11, 12, 13].forEach(pos => {
                html += `<rect id="black-${pos}" class="black-key" x="${pos * 20 - 7}" y="0" width="14" height="50" />`;
            });
            svg.innerHTML = html;
        }

        function showOnPiano(chordStr) {
            document.getElementById('visualizer').classList.remove('hidden');
            document.getElementById('chordNameDisplay').innerText = chordStr;
            document.querySelectorAll('.white-key, .black-key').forEach(k => k.classList.remove('key-active'));

            const match = chordStr.match(/([A-G][b#]?)(.*)/);
            if (!match) return;
            const root = match[1];
            const suffix = match[2] || '';
            let rootIdx = notes.indexOf(root);
            const formula = chordFormulas[suffix] || chordFormulas[''];

            formula.forEach(interval => {
                const noteIdx = (rootIdx + interval) % 12;
                const map = { 0: 'white-0', 1: 'black-1', 2: 'white-1', 3: 'black-2', 4: 'white-2', 5: 'white-3', 6: 'black-4', 7: 'white-4', 8: 'black-5', 9: 'white-5', 10: 'black-6', 11: 'white-6' };
                const keyId = map[noteIdx];
                if (keyId) document.getElementById(keyId).classList.add('key-active');
            });
        }

        function closeVisualizer() { document.getElementById('visualizer').classList.add('hidden'); }

        function toggleVideo() {
            const container = document.getElementById('youtubeContainer');
            if (container.classList.contains('hidden')) {
                container.innerHTML = `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${currentSong.youtubeId}?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                container.innerHTML = '';
            }
        }

        function setFilter(lang) {
            activeLanguage = lang;
            renderList(document.getElementById('searchInput').value);
        }

        createPiano();
        fetchLibrary();
        document.getElementById('searchInput').oninput = (e) => renderList(e.target.value);
    </script>
</body>

</html>